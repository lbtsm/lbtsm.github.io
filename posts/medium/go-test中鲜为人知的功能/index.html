<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Blog of Xm  | Go test中鲜为人知的功能</title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">

    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.56.1" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="/dist/css/app.d98f2eb6bcd1eaedb7edf166bd16af26.css" rel="stylesheet">
    

    

    
      
    

    

    <meta property="og:title" content="Go test中鲜为人知的功能" />
<meta property="og:description" content="" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://lbtsm.github.io/posts/medium/go-test%E4%B8%AD%E9%B2%9C%E4%B8%BA%E4%BA%BA%E7%9F%A5%E7%9A%84%E5%8A%9F%E8%83%BD/" />
<meta property="article:published_time" content="2019-08-02T17:06:07+08:00" />
<meta property="article:modified_time" content="2019-08-02T17:06:07+08:00" />
<meta itemprop="name" content="Go test中鲜为人知的功能">
<meta itemprop="description" content="">


<meta itemprop="datePublished" content="2019-08-02T17:06:07&#43;08:00" />
<meta itemprop="dateModified" content="2019-08-02T17:06:07&#43;08:00" />
<meta itemprop="wordCount" content="329">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Go test中鲜为人知的功能"/>
<meta name="twitter:description" content=""/>

  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://lbtsm.github.io/" class="f3 fw2 hover-white no-underline white-90 dib">
      Blog of Xm
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/posts/" title="Posts page">
              Posts
            </a>
          </li>
          
        </ul>
      
      



<a href="https://twitter.com/Zhao_MingX" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





<a href="https://github.com/lbtsm" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">

    <header class="mt4 w-100">
      <p class="f6 b helvetica tracked">
          
        POSTS
      </p>
      <h1 class="f1 athelas mb1">Go test中鲜为人知的功能</h1>
      
      <time class="f6 mv4 dib tracked" datetime="2019-08-02T17:06:07&#43;08:00">August 2, 2019</time>
      
      
    </header>

    <section class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h1 id="译-go-test中鲜为人知的功能">[译]Go test中鲜为人知的功能</h1>

<p>文本翻译自：<a href="https://medium.com/@blanchon.vincent/go-unknown-parts-of-the-test-package-df8988b2ef7f">https://medium.com/@blanchon.vincent/go-unknown-parts-of-the-test-package-df8988b2ef7f</a></p>

<h1 id="序">序</h1>

<p><code>go test</code>命令也许是开发者们在Go中经常使用的命令了，然而，在使用中你可能不了解<code>go test</code>一些有意思的细节，下面就让我们开始学习它（go test）吧！</p>

<h1 id="跳过缓存的惯用方式">跳过缓存的惯用方式</h1>

<p>在Go中，当你在命令行中连续敲下两次test命令，当test第一次尝试运行并通过时，你可以看到只有一次实际的运行，实际上，<code>go test</code>在test文件没有修改时，会使用缓存系统运行test，接下来，就让我们用math包尝试运行一下吧：</p>

<pre><code>root@91bb4e4ab781:/usr/local/go/src# go test ./math/
ok     math   0.007s
root@91bb4e4ab781:/usr/local/go/src# go test ./math/
ok     math   (cached)
</code></pre>

<p>在运行<code>go test</code>时，go会检查test文件是否有被修改，也会检查环境变量和运行时所携带的命令参数，当更新了环境变量或添加了命令行参数，则不使用缓存</p>

<pre><code>go test ./math/ -v
[...]
=== RUN   ExampleRoundToEven
--- PASS: ExampleRoundToEven (0.00s)
PASS
ok   math 0.007s
</code></pre>

<p>添加<code>-v</code>参数，在运行一次test，如图，此次test没有使用缓存，关于test的缓存，Go使用hash算法去比较运行的文件内容、环境变量和运行时所携带的命令行参数，一旦经过计算，则缓存到<code>$GOCACHE</code>对应文件夹下，在UNIX则默认缓存到<code>$CDG_CACHE_HOME</code>或者<code>$HOME/.cache</code>文件夹下，因此清除缓存则需要清除对应文件夹下的内容。</p>

<p>关于运行时所携带的<code>flags</code>，Go官方文档已作出了说明，并不是所有<code>flag</code>都会被缓存：</p>

<blockquote>
<p>运行缓存匹配的规则是，包括运行相同的test二进制文件，命令行参数完全来自一组“可缓存”的参数，包括（-cpu、-list、-parallel、-run、-short和-v），如不想使用测试缓存，下次运行test时，所携带的<code>falg</code>则与缓存中的的<code>flag</code>不相同即可，而跳过test缓存的惯用方式则是显式的使用<code>-count=1</code></p>
</blockquote>

<p>从<code>count</code>定义数字运行test以来，<code>-count=1</code>显式地说明了test只运行一次，不会多也不会少，这使得它成为跳过test缓存的惯用方式的完美候选者。</p>

<p>我们应该注意Go1.12之前，我们可以设置环境变量<code>GOCACHE=off</code>来避开测试缓存</p>

<p><code>go test math/</code></p>

<p>当我们运行test时，Go将运行指定包下的每一个包，Go处理测试报名的方式为我们提供了更多的测试策略。</p>

<h1 id="白盒测试和黑盒测试">白盒测试和黑盒测试</h1>

<p>黑盒测试由你的代码组成并且没有任何关于内部结构的知识（首字母小写的），只有可导入的函数和可获得的结构（首字母大写的），而白盒测试允许我们通过私有的方法实现内部的测试。Go原生都支持两种。这里有一个简单的程序示例，我们将为其编写白盒测试和黑盒测试去观察它们各自的优势。</p>

<pre><code class="language-go">
package deck

import (
	&quot;errors&quot;
	&quot;math/rand&quot;
)

var Empty = errors.New(&quot;Empty deck&quot;)

type Deck struct {
	cards []uint8
	shuffled bool
}

func NewDeck(numbers uint8) *Deck {
	cards := make([]uint8, 0, numbers)
	for i := uint8(0); i &lt; numbers; i++ {
		cards = append(cards, i+1)
	}

	d := Deck{ cards: cards }

	return &amp;d
}

func (d *Deck) Draw() (card uint8, err error) {
	if !d.shuffled {
		d.shuffle()
	}

	if len(d.cards) == 0 {
		return 0, Empty
	}
	card, d.cards = d.cards[0], d.cards[1:]

	return card, nil
}

func (d *Deck) shuffle() {
	rand.Shuffle(len(d.cards), func(i, j int) {
		d.cards[i], d.cards[j] = d.cards[j], d.cards[i]
	})
	d.shuffled = true
}
</code></pre>

<p>这段代码支持洗牌并且允许用户从中抽取一张牌。黑盒测试确保我们创建一副牌并且能让我们抽牌直到最后。（译者注：请注意下段代码的package，与我们实际中编写的测试包的区别）</p>

<pre><code class="language-go">package deck_test

import (
	&quot;github.com/blanchonvincent/test-package/card&quot;
	&quot;github.com/stretchr/testify/assert&quot;
	&quot;testing&quot;
)

func TestDeckCanDrawCards(t *testing.T) {
	var num uint8 = 10

	d := deck.NewDeck(num)
	for i := uint8(0); i &lt; num; i++ {
		_, err := d.Draw()
		assert.Nil(t, err)
	}
	_, err := d.Draw()
	assert.Equal(t, err, deck.Empty)
}
</code></pre>

<p>编写正确的黑盒测试的唯一条件是在导入的包名后添加_test后缀，它被视为一个不同的包，因此它无法访问测试目标包中未导出（首字母小写）的函数。Go原生地支持这种黑盒测试，并且编译器不会计较在相同路径下拥有不同的报名。</p>

<p>白盒测试将确保我们在第一次抽牌前，进行一次洗牌。</p>

<pre><code class="language-go">package deck

import (
	&quot;fmt&quot;
	&quot;github.com/stretchr/testify/assert&quot;
	&quot;testing&quot;
)

func TestDeckShouldBeShuffledOnce(t *testing.T) {
	var num uint8 = 5

	d := NewDeck(num)
	assert.Equal(t, len(d.cards), int(num))
	assert.Equal(t, d.shuffled, false, &quot;Deck should init as not shuffled&quot;)
	orderBefore := fmt.Sprint(d.cards)

	d.shuffle()
	assert.Equal(t, d.shuffled, true, &quot;Deck has not been marked as shuffled&quot;)
	orderAfter := fmt.Sprint(d.cards)

	assert.NotEqual(t, orderBefore, orderAfter, &quot;Deck once shuffled should have new card order&quot;)
}
</code></pre>

<p>这个测试使用了（与目标测试的包）相同的包名，因此可以访问私有函数（成员）</p>

<p>然而，白盒测试拥有一个约束，在黑盒测试中，测试你的公共方法，并不理会包内部的实现，因此我们可以自由的变更和提高内部的实现而不破坏任何测试，而白盒测试则与内部实现紧紧地绑在了一起，改善内部实现则会中断测试。</p>

<p>接下来，让我们走进test包的另一个特性，基准测试。</p>

<h1 id="根据你的test运行基准测试">根据你的test运行基准测试</h1>

<p>自Go1.12以来，允许你使用<code>-benchtime=1x</code>，<code>-benchtime=10x</code>等等，去运行你想运行的基准测试时间，<code>-benchtime=1x</code>标记对你的测试套件很有用，因为它至少允许你至少运行你的基准测试，来检查是否由于你上次修改而遭到破坏。</p>

<p>在Go1.12之前，我们能够使用<code>-benchtime=1ns</code>在1ns之后停止基准测试中的循环来实现相同的结果，自1ns是最小的时间单位，所以它只会运行一次基准测试。基准测试允许你获取运行时的指标，例如一次运行的时间、使用内存或者在堆中分配的内存，自Go1.13出版之后，你可以获取的指标远不止如此</p>

<h1 id="报告自定义的指标">报告自定义的指标</h1>

<p>Go1.13自带了<code>reportMetric</code>方法允许我们获取自定义的指标，让我们在先前的例子上，修改代码，在抓第一张牌之前，随机洗牌1-20次，在这里我们编写一个报告洗牌次数与基准测试次数之间比例的例子</p>

<pre><code class="language-go">package deck

import (
	&quot;testing&quot;
)

func BenchmarkGC(b *testing.B) {
	b.ReportAllocs()
	shuffled := 0

	for i := 0; i &lt; b.N; i++ {
		d := NewDeck(100)
		_, _ = d.Draw()
		shuffled += int(d.shuffled)
	}

	b.ReportMetric(float64(shuffled)/float64(b.N), &quot;shuffle/op&quot;)
}
</code></pre>

<p>然后生成结果</p>

<pre><code>BenchmarkDeckWithRandomShuffle-8       88666        12389 ns/op            5.15 shuffle/op        144 B/op         2 allocs/op
PASS
ok     1.529s
</code></pre>

<p>我们可以观察这个结果，Go1.13版本带来了有一个变化，不会再根据B.N循环而是使用真实的数字，CL允许在基准测试中减少来自外部的干扰，例如GC，尤其是在一个很小的墙时间（译者注：wall time这个词翻译的不是很好，有大牛走路路过，可以帮忙解答下吗？）内基准测试也可以跑得更快。</p><ul class="pa0">
  
</ul>
<div class="mt6">
      
      
      </div>
    </section>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://lbtsm.github.io/" >
    &copy; 2019 Blog of Xm
  </a>
    <div>



<a href="https://twitter.com/Zhao_MingX" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>





<a href="https://github.com/lbtsm" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




</div>
  </div>
</footer>

    

  <script src="/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
